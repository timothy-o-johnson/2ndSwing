define(['N/record', 'N/search', 'N/format'], function (record, search, format) {
  /**
   *  More robust version of default 2.0 search, returns data in a user-friendly way
   * @param {*} type A search type enumeration in NS (i.e search.Type.CUSTOMER)
   * @param {*} searchId (optional)
   * @param {*} filters
   * @param {*} columns
   */
  function fullSearch (type, searchId, filters, columns) {
    var searchObj = getSearchObj(type, searchId, filters, columns)
    var formattedSerachResults = getFormattedSearchResults(searchObj)

    return formattedSerachResults

    function getSearchObj (type, searchId, filters, columns) {
      var searchObj = null
      // if no saved search create a new search
      if (searchId == null) {
        searchObj = search.create({
          type: type,
          columns: columns,
          filters: filters
        })
      } else {
        // load a pre existing search
        searchObj = search.load({
          type: type,
          id: searchId
        })
        columns = searchObj.columns
      }

      log.debug('searchObj:', searchObj)
      return searchObj
    }

    function getFormattedSearchResults (searchObj) {
      var totalResults = []

      // use paged search to handle more than 4000 results
      var pagedData = searchObj.runPaged()

      pagedData.pageRanges.forEach(function (pageRange) {
        // for each page of results
        var page = pagedData.fetch({
          index: pageRange.index
        })
        page.data.forEach(function (result) {
          var resultData = {
            id: result.id
          }
          columns.forEach(function (column) {
            // build getValue/getText object
            var getObj = {
              name: column.name
            }

            // if join exists, add to object
            if (column.join) {
              getObj.join = column.join
            }
            if (column.summary) {
              getObj.summary = column.summary
            }

            // Get data for both value and text
            var resultValue = result.getValue(getObj)
            var resultText = result.getText(getObj)

            // standardize boolean values;
            // oddly, NS will sometimes use string T and F for booleans
            // ("Thank you, NS..." * womp, womp *)

            if (resultValue === 'T') {
              resultValue = true
            } else if (resultValue === 'F') {
              resultValue = false
            }

            if (typeof resultValue === 'string' && resultValue.indexOf('more..') > -1) {
              resultValue = search.lookupFields({
                type: type,
                id: result.id,
                columns: [column.name]
              })[column.name]
            }
            resultData[column.name] = {
              value: resultValue,
              text: resultText
            }
          })
          totalResults.push(resultData)
        })
      })
      return totalResults
    }
  }

  return {
    fullSearch: fullSearch
  }
})
